import gradio as gr
from config import config
import os
import uuid
SYS_PROMPT_TPL = "ä½ æ˜¯ä¸€åèµ„æ·±çš„æ–‡ç« æ’°å†™ä¸“å®¶ï¼Œå¯ä»¥å®Œæˆå¤æ‚çš„ã€é•¿æ–‡æœ¬çš„ç”Ÿæˆå·¥ä½œã€‚"
PROMPT_TPL = """æ’°å†™ä¸€ä»½æ ‡é¢˜ä¸ºã€Š{topic}ã€‹çš„æ–‡æ¡£ã€‚
è¾“å‡ºå†…å®¹æ ·å¼å¿…é¡»é‡‡ç”¨ä»¥ä¸‹templateæ ·å¼ã€‚
å…¶ä¸­##ä¸ºç« èŠ‚ï¼Œè¾“å‡ºå†…å®¹ä¸­è‡³å°‘è¦æœ‰6ä¸ªç« èŠ‚æ ‡é¢˜åŠä¸‹é¢å†…å®¹!
å…¶ä¸­##ä¸ºç« èŠ‚ï¼Œè¾“å‡ºå†…å®¹ä¸­è‡³å°‘è¦æœ‰6ä¸ªç« èŠ‚æ ‡é¢˜åŠä¸‹é¢å†…å®¹!
å…¶ä¸­##ä¸ºç« èŠ‚ï¼Œè¾“å‡ºå†…å®¹ä¸­è‡³å°‘è¦æœ‰6ä¸ªç« èŠ‚æ ‡é¢˜åŠä¸‹é¢å†…å®¹!ï¼š

template:

# æ¼”ç¤ºæ ‡é¢˜

## 1.ç« èŠ‚æ ‡é¢˜ã€‚ï¼ˆåé¢è¦æ±‚ç¦æ­¢è¾“å‡ºï¼šæ¯ä¸ª##ä¸‹é¢å¿…é¡»æœ‰2-5ä¸ª###ã€‚ï¼‰

### **ç« èŠ‚å†…å®¹**ï¼šç« èŠ‚å‰¯æ ‡é¢˜ã€‚ç« èŠ‚å‰¯æ ‡é¢˜20ä¸ªå­—ä»¥å†…çš„ã€‚
- **å†…å®¹æ ‡é¢˜**: å†…å®¹è¯¦è¿°ï¼Œ20ä¸ªå­—åˆ°100ä¸ªå­—ã€‚æ­¤-å¿…é¡»å¿…é¡»åŒ…å«åŠ ç²—çš„å†…å®¹æ ‡é¢˜ã€‚
- **å†…å®¹æ ‡é¢˜**: å†…å®¹è¯¦è¿°ï¼Œ20ä¸ªå­—åˆ°100ä¸ªå­—ã€‚æ­¤-å¿…é¡»å¿…é¡»åŒ…å«åŠ ç²—çš„å†…å®¹æ ‡é¢˜ã€‚
- **å†…å®¹æ ‡é¢˜**: å†…å®¹è¯¦è¿°ï¼Œ20ä¸ªå­—åˆ°100ä¸ªå­—ã€‚æ­¤-å¿…é¡»å¿…é¡»åŒ…å«åŠ ç²—çš„å†…å®¹æ ‡é¢˜ã€‚çœ‹å†…å®¹æ˜¯å¦éœ€è¦æ­¤-ï¼Œå¦åˆ™åˆ é™¤æ­¤è¡Œã€‚
- **å†…å®¹æ ‡é¢˜**: å†…å®¹è¯¦è¿°ï¼Œ20ä¸ªå­—åˆ°100ä¸ªå­—ã€‚æ­¤-å¿…é¡»å¿…é¡»åŒ…å«åŠ ç²—çš„å†…å®¹æ ‡é¢˜ã€‚çœ‹å†…å®¹æ˜¯å¦éœ€è¦æ­¤-ï¼Œå¦åˆ™åˆ é™¤æ­¤è¡Œã€‚
- **å†…å®¹æ ‡é¢˜**: å†…å®¹è¯¦è¿°ï¼Œ20ä¸ªå­—åˆ°100ä¸ªå­—ã€‚æ­¤-å¿…é¡»å¿…é¡»åŒ…å«åŠ ç²—çš„å†…å®¹æ ‡é¢˜ã€‚çœ‹å†…å®¹æ˜¯å¦éœ€è¦æ­¤-ï¼Œå¦åˆ™åˆ é™¤æ­¤è¡Œã€‚
- ![ä¸»é¢˜](https://source.unsplash.com/1000x600/?+è‹±æ–‡ä¸»é¢˜)

### **è¡¨æ ¼ç« èŠ‚å†…å®¹**ï¼šç« èŠ‚å‰¯æ ‡é¢˜ã€‚è¡¨æ ¼å†…å®¹ä¸‹é¢ä¸éœ€è¦å¢åŠ ä¸»é¢˜é…å›¾ã€‚
| title | col1 | col2 |
| --- | --- | --- |
| item1 | 2 | 3 |
| item2 | 5 | 6 |

### **ç« èŠ‚å†…å®¹**ï¼šç« èŠ‚å‰¯æ ‡é¢˜ã€‚ç« èŠ‚å‰¯æ ‡é¢˜20ä¸ªå­—ä»¥å†…çš„ã€‚
- **å†…å®¹æ ‡é¢˜**: å†…å®¹è¯¦è¿°ï¼Œ20ä¸ªå­—åˆ°100ä¸ªå­—ã€‚æ­¤-å¿…é¡»å¿…é¡»åŒ…å«åŠ ç²—çš„å†…å®¹æ ‡é¢˜ã€‚
- **å†…å®¹æ ‡é¢˜**: å†…å®¹è¯¦è¿°ï¼Œ20ä¸ªå­—åˆ°100ä¸ªå­—ã€‚æ­¤-å¿…é¡»å¿…é¡»åŒ…å«åŠ ç²—çš„å†…å®¹æ ‡é¢˜ã€‚
- **å†…å®¹æ ‡é¢˜**: å†…å®¹è¯¦è¿°ï¼Œ20ä¸ªå­—åˆ°100ä¸ªå­—ã€‚æ­¤-å¿…é¡»å¿…é¡»åŒ…å«åŠ ç²—çš„å†…å®¹æ ‡é¢˜ã€‚çœ‹å†…å®¹æ˜¯å¦éœ€è¦æ­¤-ï¼Œå¦åˆ™åˆ é™¤æ­¤è¡Œã€‚
- **å†…å®¹æ ‡é¢˜**: å†…å®¹è¯¦è¿°ï¼Œ20ä¸ªå­—åˆ°100ä¸ªå­—ã€‚æ­¤-å¿…é¡»å¿…é¡»åŒ…å«åŠ ç²—çš„å†…å®¹æ ‡é¢˜ã€‚çœ‹å†…å®¹æ˜¯å¦éœ€è¦æ­¤-ï¼Œå¦åˆ™åˆ é™¤æ­¤è¡Œã€‚
- **å†…å®¹æ ‡é¢˜**: å†…å®¹è¯¦è¿°ï¼Œ20ä¸ªå­—åˆ°100ä¸ªå­—ã€‚æ­¤-å¿…é¡»å¿…é¡»åŒ…å«åŠ ç²—çš„å†…å®¹æ ‡é¢˜ã€‚çœ‹å†…å®¹æ˜¯å¦éœ€è¦æ­¤-ï¼Œå¦åˆ™åˆ é™¤æ­¤è¡Œã€‚
- ![ä¸»é¢˜](https://source.unsplash.com/1000x600/?+è‹±æ–‡ä¸»é¢˜)

### ![ä¸»é¢˜](https://source.unsplash.com/1000x600/?+è‹±æ–‡ä¸»é¢˜)

## 2.ç« èŠ‚æ ‡é¢˜ï¼ˆåé¢è¦æ±‚ç¦æ­¢è¾“å‡ºï¼šä¸‹é¢çš„å†…å®¹å‚ç…§ä¸Šé¢çš„æ¨¡æ¿ã€‚æ¯ä¸ª##ä¸‹é¢å¿…é¡»æœ‰2-5ä¸ª###ã€‚éœ€è¦æœ‰6ä¸ªç« èŠ‚æ ‡é¢˜åŠä¸‹é¢å†…å®¹ã€‚ï¼‰"""


def generate_presentation_md(topic):
    gen = config.llm.chat_once(
        prompt=PROMPT_TPL.format(topic=topic),
        system_prompt=SYS_PROMPT_TPL,
        model_name="moonshot-v1-8k",
        temperature=0.1,
    )
    content = ""
    for partial_content in gen:
        content += partial_content

    # ç¼“å­˜åˆ°cache folderä¸­å¹¶ä»¥éšæœºIDå‘½å
    random_id = uuid.uuid4().hex[:8]
    with open(os.path.join(os.getcwd(), f"{config.cache_folder}/{random_id}.md"), "w", encoding="utf-8") as f:
        f.write(content)
    return content, random_id


def generate_live_link(pid):
    return f"""ğŸ‘‡ åœ¨çº¿ä½“éªŒé“¾æ¥å·²ç”Ÿæˆ: 

[ç‚¹å‡»æ­¤å¤„è®¿é—®åœ¨çº¿PPT](http://127.0.0.1:8080/presentation/{pid})"""


def reveal_generator_tab():
    with gr.Tab("åœ¨çº¿PPTç”Ÿæˆ"):
        with gr.Row():
            topic_textbox = gr.Textbox(label="Topic", scale=3)
            random_id_textbox = gr.Textbox(label="å†…å®¹éšæœºç ID", interactive=False, scale=1)
            generate_md_btn = gr.Button("ğŸ¤– AI Generate MD", scale=1)
            generate_link_btn = gr.Button("Generate Live Link", scale=1)

        with gr.Row():
            generated_md = gr.Markdown("ğŸ‘‰ ç‚¹å‡»æŒ‰é’® [ğŸ¤– AI Generate MD] ç”Ÿæˆå†…å®¹")

        generate_md_btn.click(fn=generate_presentation_md, inputs=topic_textbox, outputs=[
                              generated_md, random_id_textbox])

        generate_link_btn.click(fn=generate_live_link,
                                inputs=random_id_textbox, outputs=generated_md)
